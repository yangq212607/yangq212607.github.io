<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"default"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="ActivityThread是Activity里一个很重要的成员变量，俗称UI线程，也即应用的主线程,它自身有三个比较关键的成员变量，其中之一是ApplicationThread,在ActivityThread创建的时候作为全局变量被创建: 1234final ApplicationThread mAppThread = new ApplicationThread();final Applicat">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android应用启动流程分析">
<meta property="og:url" content="http://yangq.me/post/c1c83cc.html">
<meta property="og:site_name" content="yangq&#39;s blog">
<meta property="og:description" content="ActivityThread是Activity里一个很重要的成员变量，俗称UI线程，也即应用的主线程,它自身有三个比较关键的成员变量，其中之一是ApplicationThread,在ActivityThread创建的时候作为全局变量被创建: 1234final ApplicationThread mAppThread = new ApplicationThread();final Applicat">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://image.yangq.me/blog/history/16-7-5/activityStart.png">
<meta property="og:updated_time" content="2019-04-27T10:13:13.070Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android应用启动流程分析">
<meta name="twitter:description" content="ActivityThread是Activity里一个很重要的成员变量，俗称UI线程，也即应用的主线程,它自身有三个比较关键的成员变量，其中之一是ApplicationThread,在ActivityThread创建的时候作为全局变量被创建: 1234final ApplicationThread mAppThread = new ApplicationThread();final Applicat">
<meta name="twitter:image" content="http://image.yangq.me/blog/history/16-7-5/activityStart.png">
  <link rel="canonical" href="http://yangq.me/post/c1c83cc">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Android应用启动流程分析 | yangq's blog</title>
  <meta name="generator" content="Hexo 3.9.0">
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yangq's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">观心中月,破心中贼</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">20</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">6</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">8</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yangq.me/post/c1c83cc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老实念佛">
      <meta itemprop="description" content="小小程序员">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangq's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Android应用启动流程分析

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2017-02-12 17:31:43" itemprop="dateCreated datePublished" datetime="2017-02-12T17:31:43+08:00">2017-02-12</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-04-27 18:13:13" itemprop="dateModified" datetime="2019-04-27T18:13:13+08:00">2019-04-27</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><code>ActivityThread</code>是<code>Activity</code>里一个很重要的成员变量，俗称UI线程，也即应用的主线程,它自身有三个比较关键的成员变量，其中之一是<code>ApplicationThread</code>,在<code>ActivityThread</code>创建的时候作为全局变量被创建:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">final ApplicationThread mAppThread = <span class="keyword">new</span> <span class="constructor">ApplicationThread()</span>;</span><br><span class="line">final ApplicationThread mAppThread = <span class="keyword">new</span> <span class="constructor">ApplicationThread()</span>;</span><br><span class="line">final Looper mLooper = <span class="module-access"><span class="module"><span class="identifier">Looper</span>.</span></span>my<span class="constructor">Looper()</span>;</span><br><span class="line">final H mH = <span class="keyword">new</span> <span class="constructor">H()</span>;</span><br></pre></td></tr></table></figure>

<a id="more"></a>
<p><code>ApplicationThread</code>是<code>ActivityThread</code>里一个内部类，继承自<code>ApplicationThreadNative</code>,而<code>ApplicationThreadNative</code>又继承自<code>Binder</code>并<strong>implements</strong>了<code>IApplicationThread</code>接口(此处并没有真正实现)，<code>IApplicationThread</code>继承<code>IInterface</code>,定义了一系列操作应用的接口，用来和AMS进行通信,其中和Activity生命周期相关的几个关键函数如下:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void schedule<span class="constructor">PauseActivity(IBinder <span class="params">token</span>, <span class="params">boolean</span> <span class="params">finished</span>, <span class="params">boolean</span> <span class="params">userLeaving</span>,<span class="params">int</span> <span class="params">configChanges</span>, <span class="params">boolean</span> <span class="params">dontReport</span>)</span> throws RemoteException;</span><br><span class="line"></span><br><span class="line">void schedule<span class="constructor">StopActivity(IBinder <span class="params">token</span>, <span class="params">boolean</span> <span class="params">showWindow</span>,<span class="params">int</span> <span class="params">configChanges</span>)</span> throws RemoteException;</span><br><span class="line"></span><br><span class="line">void schedule<span class="constructor">ResumeActivity(IBinder <span class="params">token</span>, <span class="params">int</span> <span class="params">procState</span>, <span class="params">boolean</span> <span class="params">isForward</span>, Bundle <span class="params">resumeArgs</span>)</span>throws RemoteException;</span><br></pre></td></tr></table></figure>

<p><code>IInterface.java</code>代码如下:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IInterface</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Retrieve the Binder object associated with this interface.</span></span><br><span class="line"><span class="comment">     * You must use this instead of a plain cast, so that proxy objects</span></span><br><span class="line"><span class="comment">     * can return the correct result.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> IBinder asBinder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Binder.java</code>实现了<code>IBinder</code>接口，核心的<code>onTransact</code>函数和<code>transact</code>代码如下:</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">boolean</span> onTransact(<span class="keyword">int</span> code, Parcel data, Parcel reply,</span><br><span class="line">            <span class="keyword">int</span> flags) <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">if</span> (code == INTERFACE_TRANSACTION) &#123;</span><br><span class="line">            reply.writeString(getInterfaceDescriptor());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(code == DUMP_TRANSACTION)</span> </span>&#123;</span><br><span class="line">            ParcelFileDescriptor fd = data.readFileDescriptor();</span><br><span class="line">            String[] args = data.readStringArray();</span><br><span class="line">            <span class="keyword">if</span> (fd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    dump(fd.getFileDescriptor(), args);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    IoUtils.closeQuietly(fd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    ........</span><br></pre></td></tr></table></figure>

<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> transact(<span class="keyword">int</span> code, Parcel data, Parcel reply,</span><br><span class="line">          <span class="keyword">int</span> flags) <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">false</span>) Log.v(<span class="string">"Binder"</span>, <span class="string">"Transact: "</span> + code + <span class="string">" to "</span> + <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">          data.setDataPosition(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">boolean</span> r = onTransact(code, data, reply, flags);</span><br><span class="line">      <span class="keyword">if</span> (reply != <span class="keyword">null</span>) &#123;</span><br><span class="line">          reply.setDataPosition(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> r;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>注意上面的<code>transact()</code>函数是<strong>final</strong>修饰，不可被子类重写，但<code>onTransact()</code>可以被重写。<br><code>ApplicationThreadNative</code>的主要功能就是重写了<code>onTransact</code>函数，根据不同的<code>code</code>路由给内部类<code>ApplicationThreadProxy</code>(实现了<code>IApplicationThread</code>接口),完成和binder通讯的部分.<br>也即真正实现<code>IApplicationThread</code>接口的有两个类：<code>ApplicationThread</code>和<code>ApplicationThreadProxy</code>,其中<code>ApplicationThread</code>负责通过<code>ActivityThread</code>最终控制<code>Activity</code>的生命周期，<code>ApplicationThreadProxy</code>负责对应功能与Binder通讯的部门。<br>也可以说<code>ApplicationThread</code>具有上面两部分功能，只不过按层次实现在不同类里.</p>
<p>以<code>schedulePauseActivity()</code>接口为例，<code>ApplicationThreadProxy</code>实现为:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">public</span> final void schedulePauseActivity(<span class="type">IBinder</span> token, boolean finished,</span><br><span class="line">        boolean userLeaving, int configChanges, boolean dontReport) throws <span class="type">RemoteException</span> &#123;</span><br><span class="line">    <span class="type">Parcel</span> <span class="class"><span class="keyword">data</span> = <span class="type">Parcel</span>.obtain();</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInterfaceToken(<span class="type">IApplicationThread</span>.<span class="title">descriptor</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeStrongBinder(<span class="title">token</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInt(<span class="title">finished</span> ? 1 : 0);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInt(<span class="title">userLeaving</span> ? 1 :0);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInt(<span class="title">configChanges</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInt(<span class="title">dontReport</span> ? 1 : 0);</span></span><br><span class="line">    mRemote.transact(<span class="type">SCHEDULE_PAUSE_ACTIVITY_TRANSACTION</span>, <span class="class"><span class="keyword">data</span>, null,</span></span><br><span class="line">            <span class="type">IBinder</span>.<span class="type">FLAG_ONEWAY</span>);</span><br><span class="line">    <span class="class"><span class="keyword">data</span>.recycle();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ApplicationThread</code>对其实现为:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> schedulePauseActivity(IBinder token, <span class="keyword">boolean</span> finished,</span><br><span class="line">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport) &#123;</span><br><span class="line">    <span class="keyword">int</span> seq = getLifecycleSeq();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ORDER) Slog.d(TAG, <span class="string">"pauseActivity "</span> + ActivityThread.<span class="keyword">this</span></span><br><span class="line">            + <span class="string">" operation received seq: "</span> + seq);</span><br><span class="line">    sendMessage(</span><br><span class="line">            finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</span><br><span class="line">            token,</span><br><span class="line">            (userLeaving ? USER_LEAVING : <span class="number">0</span>) | (dontReport ? DONT_REPORT : <span class="number">0</span>),</span><br><span class="line">            configChanges,</span><br><span class="line">            seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中sendMessage实现为:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void send<span class="constructor">Message(<span class="params">int</span> <span class="params">what</span>, Object <span class="params">obj</span>, <span class="params">int</span> <span class="params">arg1</span>, <span class="params">int</span> <span class="params">arg2</span>, <span class="params">boolean</span> <span class="params">async</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>v(</span><br><span class="line">        TAG, <span class="string">"SCHEDULE "</span> + what + <span class="string">" "</span> + mH.code<span class="constructor">ToString(<span class="params">what</span>)</span></span><br><span class="line">        + <span class="string">": "</span> + arg1 + <span class="string">" / "</span> + obj);</span><br><span class="line">    Message msg = <span class="module-access"><span class="module"><span class="identifier">Message</span>.</span></span>obtain<span class="literal">()</span>;</span><br><span class="line">    msg.what = what;</span><br><span class="line">    msg.obj = obj;</span><br><span class="line">    msg.arg1 = arg1;</span><br><span class="line">    msg.arg2 = arg2;</span><br><span class="line">    <span class="keyword">if</span> (async) &#123;</span><br><span class="line">        msg.set<span class="constructor">Asynchronous(<span class="params">true</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mH.send<span class="constructor">Message(<span class="params">msg</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mH继承自<code>Handler</code>负责处理ApplicationThread发送到消息队列的消息，例如：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</span><br><span class="line">         <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">             <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">                 Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">                 <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">                 r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                         r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">                 handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">                 Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">             &#125; <span class="keyword">break</span>;</span><br><span class="line">       .........</span><br></pre></td></tr></table></figure>

<p>上面把<code>ActivityThread</code>、<code>ApplicationThread</code>、<code>ApplicationThreadProxy</code>、<code>ApplicationThreadNative</code>的关系说清楚了，下面接着看流程.</p>
<h2 id="step3–Instrumentation-execStartActivity"><a href="#step3–Instrumentation-execStartActivity" class="headerlink" title="step3–Instrumentation.execStartActivity"></a>step3–Instrumentation.execStartActivity</h2><p><code>Instrumentation</code>里的<code>execStartActivity()</code>核心代码如下:</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ActivityResult execStartActivity(</span><br><span class="line">        Context who, IBinder contextThread, IBinder token, Activity <span class="keyword">target</span>,</span><br><span class="line">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options) &#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    Uri referrer = <span class="keyword">target</span> != <span class="keyword">null</span> ? <span class="keyword">target</span>.onProvideReferrer() : <span class="keyword">null</span>;</span><br><span class="line">      .........</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess(who);</span><br><span class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, <span class="keyword">target</span> != <span class="keyword">null</span> ? <span class="keyword">target</span>.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                    requestCode, 0, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最关键的是<code>int result = ActivityManagerNative.getDefault().startActivity(...)</code>,<code>ActivityManagerNative</code>在路径:<code>/frameworks/base/core/java/android/app/ActivityManagerNative.java</code>,其中的<code>getDefault()</code>函数返回内部的变量:<code>gDefault</code>:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> static final Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;<span class="literal">()</span> &#123;</span><br><span class="line">    protected IActivityManager create<span class="literal">()</span> &#123;</span><br><span class="line">            IBinder b = <span class="module-access"><span class="module"><span class="identifier">ServiceManager</span>.</span></span>get<span class="constructor">Service(<span class="string">"activity"</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">            &#125;</span><br><span class="line">            IActivityManager am = <span class="keyword">as</span><span class="constructor">Interface(<span class="params">b</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">            &#125;</span><br><span class="line">            return am;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ServiceManager</code>路径<code>/frameworks/base/core/java/android/os/ServiceManager.java</code>,它就是Android的ServiceManager进程，本身也是一个服务，内部通过一个HashMap类型<code>sCache</code>变量保存各种Service的Binder接口,如下:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private static HashMap&lt;String, IBinder&gt; sCache = new HashMap&lt;String, IBinder&gt;();</span><br><span class="line"></span><br><span class="line">public static IBinder getService(String name) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            IBinder<span class="built_in"> service </span>= sCache.<span class="builtin-name">get</span>(name);</span><br><span class="line">            <span class="keyword">if</span> (service != <span class="literal">null</span>) &#123;</span><br><span class="line">                return service;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                return getIServiceManager().getService(name);</span><br><span class="line">            &#125;</span><br><span class="line"> <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">public static void addService(String name, IBinder service) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            getIServiceManager().addService(name, service, <span class="literal">false</span>);</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"error in addService"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从中可以看到gDefault实质是ActivityManagerService的远程接口,然后通过<code>asInterface</code>这个函数将一个Binder对象转为IActivityManager接口，并生成了一个<code>ActivityManagerProxy</code>对象：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Cast a Binder object into an activity manager interface, generating</span></span><br><span class="line"><span class="comment">  * a proxy if needed.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span>(<span class="params">IBinder obj</span>)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     IActivityManager <span class="keyword">in</span> =</span><br><span class="line">         (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">in</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">in</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>所以最终又调到了ActivityManagerProxy.startActivity函数.<br>这里<code>ActivityManagerNative</code>和<code>ActivityManagerProxy</code>,与<code>ApplicationThreadNative</code>和<code>ApplicationThreadProxy</code>在实现模式上是一样的。</p>
<h2 id="step4–ActivityManagerProxy-startActivity"><a href="#step4–ActivityManagerProxy-startActivity" class="headerlink" title="step4–ActivityManagerProxy.startActivity"></a>step4–ActivityManagerProxy.startActivity</h2><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">ActivityManagerProxy</span> implements <span class="type">IActivityManager</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class">    public <span class="type">ActivityManagerProxy</span>(<span class="type">IBinder</span> <span class="title">remote</span>)</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line"><span class="class">        mRemote = remote;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    public int startActivity(<span class="type">IApplicationThread</span> <span class="title">caller</span>, <span class="type">String</span> <span class="title">callingPackage</span>, <span class="type">Intent</span> <span class="title">intent</span>,</span></span><br><span class="line"><span class="class">            <span class="type">String</span> <span class="title">resolvedType</span>, <span class="type">IBinder</span> <span class="title">resultTo</span>, <span class="type">String</span> <span class="title">resultWho</span>, <span class="title">int</span> <span class="title">requestCode</span>,</span></span><br><span class="line"><span class="class">            <span class="title">int</span> <span class="title">startFlags</span>, <span class="type">ProfilerInfo</span> <span class="title">profilerInfo</span>, <span class="type">Bundle</span> <span class="title">options</span>) throws <span class="type">RemoteException</span> &#123;</span></span><br><span class="line"><span class="class">        <span class="type">Parcel</span> data = <span class="type">Parcel</span>.obtain();</span></span><br><span class="line"><span class="class">        <span class="type">Parcel</span> reply = <span class="type">Parcel</span>.obtain();</span></span><br><span class="line"><span class="class">        data.writeInterfaceToken(<span class="type">IActivityManager</span>.<span class="title">descriptor</span>);</span></span><br><span class="line"><span class="class">        data.writeStrongBinder(<span class="title">caller</span> != <span class="title">null</span> ? <span class="title">caller</span>.<span class="title">asBinder</span>() : null);</span></span><br><span class="line"><span class="class">        ......data.writeString(<span class="title">callingPackage</span>);</span></span><br><span class="line"><span class="class">        intent.writeToParcel(<span class="title">data</span>, 0);</span></span><br><span class="line"><span class="class">        ...</span></span><br><span class="line"><span class="class">        mRemote.transact(<span class="type">START_ACTIVITY_TRANSACTION</span>, <span class="title">data</span>, <span class="title">reply</span>, 0);</span></span><br><span class="line"><span class="class">        reply.readException();</span></span><br><span class="line"><span class="class">        int result = reply.readInt();</span></span><br><span class="line"><span class="class">        reply.recycle();</span></span><br><span class="line"><span class="class">        data.recycle();</span></span><br><span class="line"><span class="class">        return result;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br></pre></td></tr></table></figure>

<p>上面说过在ActivityManagerProxy被创建的时候传进来一个IBinder对象，这个就是AMS的远程调用接口，也即<code>mRemote</code>变量.这里最核心的一句是:<code>mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, 0)</code>。</p>
<h2 id="step4–ActivityManagerService-startActivity"><a href="#step4–ActivityManagerService-startActivity" class="headerlink" title="step4–ActivityManagerService.startActivity"></a>step4–ActivityManagerService.startActivity</h2><p>上个步骤里的mRemote.transact()就是利用binder驱动进行跨进程通信的过程，在mRemote的onTransact函数里一定有个地方去响应<code>START_ACTIVITY_TRANSACTION</code>这个命令。</p>
<p><strong>注意:上面的步骤都是在初始应用程序A进程里，在onTransact时来到了AMS，也即AMS所在的SystemServer进程.</strong></p>
<p>我们直接到<code>ActivityManagerService</code>里去找.<br>源码在<code>/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code>,它继承了上面的<code>ActivityManagerNative</code>,在其<code>onTransact</code>函数里找到:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public boolean on<span class="constructor">Transact(<span class="params">int</span> <span class="params">code</span>, Parcel <span class="params">data</span>, Parcel <span class="params">reply</span>, <span class="params">int</span> <span class="params">flags</span>)</span></span><br><span class="line">            throws RemoteException &#123;</span><br><span class="line">        switch (code) &#123;</span><br><span class="line">        case START_ACTIVITY_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            data.enforce<span class="constructor">Interface(IActivityManager.<span class="params">descriptor</span>)</span>;</span><br><span class="line">            IBinder b = data.read<span class="constructor">StrongBinder()</span>;</span><br><span class="line">            IApplicationThread app = <span class="module-access"><span class="module"><span class="identifier">ApplicationThreadNative</span>.</span></span><span class="keyword">as</span><span class="constructor">Interface(<span class="params">b</span>)</span>;</span><br><span class="line">            String callingPackage = data.read<span class="constructor">String()</span>;</span><br><span class="line">           .............</span><br><span class="line">            <span class="built_in">int</span> result = start<span class="constructor">Activity(<span class="operator">...</span><span class="operator">...</span>..)</span>;</span><br><span class="line">            reply.write<span class="constructor">NoException()</span>;</span><br><span class="line">            reply.write<span class="constructor">Int(<span class="params">result</span>)</span>;</span><br><span class="line">            return <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里又调用了<code>startActivity</code>函数，但是<code>ActivityManagerNative</code>是个abstract类，并没有真正实现<code>IActivityManager</code>接口，其实现在其子类<code>ActivityManagerService</code>里。它又调了内部的<code>startActivityAsUser()</code>函数,最终又进到<code>mActivityStarter.startActivityMayWait()</code>函数里。</p>
<h2 id="step5–ActivityStarter-startActivityMayWait"><a href="#step5–ActivityStarter-startActivityMayWait" class="headerlink" title="step5–ActivityStarter.startActivityMayWait"></a>step5–ActivityStarter.startActivityMayWait</h2><p><strong>备注:此处往下的流程集中在<code>ActivityStackSupervisor</code>、<code>ActivityStack</code>、<code>ActivityStarter</code>比较复杂，只交代调用流程，不作太多解释.</strong><br><code>startActivityMayWait()</code>这个函数比较长，最终又调了内部的<code>startActivityLocked</code>里。<br>doPendingActivityLaunchesLocked—startActivityUnchecked,在<code>startActivityUnchecked</code>通过<code>mSupervisor.resumeFocusedStackTopActivityLocked()</code>,进到<code>ActivityStackSupervisor</code>,然后进到<code>ActivityStack.resumeTopActivityUncheckedLocked</code>,再调内部的<code>resumeTopActivityInnerLocked()</code>函数，再调内部的<code>startPausingLocked</code>函数,其中关键一句:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">prev</span><span class="selector-class">.app</span><span class="selector-class">.thread</span><span class="selector-class">.schedulePauseActivity</span>(<span class="selector-tag">prev</span><span class="selector-class">.appToken</span>, <span class="selector-tag">prev</span><span class="selector-class">.finishing</span>,</span><br><span class="line">                        <span class="selector-tag">userLeaving</span>, <span class="selector-tag">prev</span><span class="selector-class">.configChangeFlags</span>, <span class="selector-tag">dontWait</span>);</span><br></pre></td></tr></table></figure>

<p>这里<code>prev</code>类型为<code>ActivityRecord</code>,<code>app</code>类型为<code>ProcessRecord</code>,<code>thread</code>类型为<code>IApplicationThread</code>,即<code>prev.app.thread</code>是运行在<code>ActivityManagerService</code>进程里的``ApplicationThread<code>的远程调用接口</code>ApplicationThreadProxy`.</p>
<h2 id="step6–ApplicationThreadProxy-schedulePauseActivity"><a href="#step6–ApplicationThreadProxy-schedulePauseActivity" class="headerlink" title="step6–ApplicationThreadProxy.schedulePauseActivity"></a>step6–ApplicationThreadProxy.schedulePauseActivity</h2><p>代码如下:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      boolean userLeaving, int configChanges, boolean dontReport) throws <span class="type">RemoteException</span> &#123;</span><br><span class="line">    <span class="type">Parcel</span> <span class="class"><span class="keyword">data</span> = <span class="type">Parcel</span>.obtain();</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInterfaceToken(<span class="type">IApplicationThread</span>.<span class="title">descriptor</span>);</span></span><br><span class="line">    ..........</span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInt(<span class="title">dontReport</span> ? 1 : 0);</span></span><br><span class="line">    mRemote.transact(<span class="type">SCHEDULE_PAUSE_ACTIVITY_TRANSACTION</span>, <span class="class"><span class="keyword">data</span>, null,</span></span><br><span class="line">            <span class="type">IBinder</span>.<span class="type">FLAG_ONEWAY</span>);</span><br><span class="line">    <span class="class"><span class="keyword">data</span>.recycle();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过进程间通信，来到<code>ApplicationThreadNative</code>里的<code>onTransact</code>函数:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public boolean on<span class="constructor">Transact(<span class="params">int</span> <span class="params">code</span>, Parcel <span class="params">data</span>, Parcel <span class="params">reply</span>, <span class="params">int</span> <span class="params">flags</span>)</span></span><br><span class="line">            throws RemoteException &#123;</span><br><span class="line">        switch (code) &#123;</span><br><span class="line">        case SCHEDULE_PAUSE_ACTIVITY_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            data.enforce<span class="constructor">Interface(IApplicationThread.<span class="params">descriptor</span>)</span>;</span><br><span class="line">            IBinder b = data.read<span class="constructor">StrongBinder()</span>;</span><br><span class="line">            ......</span><br><span class="line">            schedule<span class="constructor">PauseActivity(<span class="params">b</span>, <span class="params">finished</span>, <span class="params">userLeaving</span>, <span class="params">configChanges</span>, <span class="params">dontReport</span>)</span>;</span><br><span class="line">            return <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="step7–ApplicationThread-schedulePauseActivity"><a href="#step7–ApplicationThread-schedulePauseActivity" class="headerlink" title="step7–ApplicationThread.schedulePauseActivity"></a>step7–ApplicationThread.schedulePauseActivity</h2><p><strong>注意:经过上面步骤里的onTransact来到了Launcher进程里.</strong><br><code>schedulePauseActivity()</code>通过<code>ActivityThread</code>里的Handler<code>mH</code>,将消息转发至UI线程里。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">case PAUSE_ACTIVITY: &#123;</span><br><span class="line">                  <span class="module-access"><span class="module"><span class="identifier">Trace</span>.</span></span>trace<span class="constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityPause"</span>)</span>;</span><br><span class="line">                  SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">                  handle<span class="constructor">PauseActivity((IBinder)</span> args.arg1, <span class="literal">false</span>,</span><br><span class="line">                          (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>, args.argi2,</span><br><span class="line">                          (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</span><br><span class="line">                  maybe<span class="constructor">Snapshot()</span>;</span><br><span class="line">                  <span class="module-access"><span class="module"><span class="identifier">Trace</span>.</span></span>trace<span class="constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;</span><br><span class="line">              &#125; break;</span><br></pre></td></tr></table></figure>

<p>进到了<code>handlePauseActivity()</code>:</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> handlePauseActivity(IBinder token, <span class="keyword">boolean</span> finished,</span><br><span class="line">            <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport, <span class="keyword">int</span> seq) &#123;</span><br><span class="line">        ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            performPauseActivity(token, finished, r.isPreHoneycomb(), <span class="string">"handlePauseActivity"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Tell the activity manager we have paused.</span></span><br><span class="line">            <span class="keyword">if</span> (!dontReport) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ActivityManagerNative.getDefault().activityPaused(token);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>函数首先将Binder引用token转换成ActivityRecord的远程接口ActivityClientRecord，然后做了三个事情：</p>
<ol>
<li>如果userLeaving为true，则通过调用performUserLeavingActivity函数来调用Activity.onUserLeaveHint通知Activity，用户要离开它了；</li>
<li>调用performPauseActivity函数来调用Activity.onPause函数，我们知道，在Activity的生命周期中，当它要让位于其它的Activity时，系统就会调用它的onPause函数；</li>
<li>它通知ActivityManagerService，这个Activity已经进入Paused状态了，ActivityManagerService现在可以完成未竟的事情，即启动MainActivity了。<br><code>ActivityManagerProxy</code>里<code>activityPaused</code>函数如下:<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">public</span> void activityPaused(<span class="type">IBinder</span> token) throws <span class="type">RemoteException</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Parcel</span> <span class="class"><span class="keyword">data</span> = <span class="type">Parcel</span>.obtain();</span></span><br><span class="line">        <span class="type">Parcel</span> reply = <span class="type">Parcel</span>.obtain();</span><br><span class="line">        <span class="class"><span class="keyword">data</span>.writeInterfaceToken(<span class="type">IActivityManager</span>.<span class="title">descriptor</span>);</span></span><br><span class="line">        <span class="class"><span class="keyword">data</span>.writeStrongBinder(<span class="title">token</span>);</span></span><br><span class="line">        mRemote.transact(<span class="type">ACTIVITY_PAUSED_TRANSACTION</span>, <span class="class"><span class="keyword">data</span>, reply, 0);</span></span><br><span class="line">        reply.readException();</span><br><span class="line">        <span class="class"><span class="keyword">data</span>.recycle();</span></span><br><span class="line">        reply.recycle();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="step8–ActivityManagerService-activityPaused"><a href="#step8–ActivityManagerService-activityPaused" class="headerlink" title="step8–ActivityManagerService.activityPaused"></a>step8–ActivityManagerService.activityPaused</h2><p><strong>备注:又来到了AMS所在的进程！！！</strong><br>上面的步骤经过进程间通信来到ActivityManagerNative里的：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">case</span> <span class="type">ACTIVITY_PAUSED_TRANSACTION</span>: &#123;</span><br><span class="line">           <span class="class"><span class="keyword">data</span>.enforceInterface(<span class="type">IActivityManager</span>.<span class="title">descriptor</span>);</span></span><br><span class="line">           <span class="type">IBinder</span> token = <span class="class"><span class="keyword">data</span>.readStrongBinder();</span></span><br><span class="line">           activityPaused(token);</span><br><span class="line">           reply.writeNoException();</span><br><span class="line">           return true;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>调到AMS的<code>activityPaused()</code>函数。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public final void activity<span class="constructor">Paused(IBinder <span class="params">token</span>)</span> &#123;</span><br><span class="line">       final long origId = <span class="module-access"><span class="module"><span class="identifier">Binder</span>.</span></span>clear<span class="constructor">CallingIdentity()</span>;</span><br><span class="line">       synchronized(this) &#123;</span><br><span class="line">           ActivityStack stack = <span class="module-access"><span class="module"><span class="identifier">ActivityRecord</span>.</span></span>get<span class="constructor">StackLocked(<span class="params">token</span>)</span>;</span><br><span class="line">           <span class="keyword">if</span> (stack != null) &#123;</span><br><span class="line">               stack.activity<span class="constructor">PausedLocked(<span class="params">token</span>, <span class="params">false</span>)</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="module-access"><span class="module"><span class="identifier">Binder</span>.</span></span>restore<span class="constructor">CallingIdentity(<span class="params">origId</span>)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="step9–ActivityStack-activityPausedLocked"><a href="#step9–ActivityStack-activityPausedLocked" class="headerlink" title="step9–ActivityStack.activityPausedLocked"></a>step9–ActivityStack.activityPausedLocked</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">final void activity<span class="constructor">PausedLocked(IBinder <span class="params">token</span>, <span class="params">boolean</span> <span class="params">timeout</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE) <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>v(TAG_PAUSE,</span><br><span class="line">            <span class="string">"Activity paused: token="</span> + token + <span class="string">", timeout="</span> + timeout);</span><br><span class="line"></span><br><span class="line">        final ActivityRecord r = is<span class="constructor">InStackLocked(<span class="params">token</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (r != null) &#123;</span><br><span class="line">            mHandler.remove<span class="constructor">Messages(PAUSE_TIMEOUT_MSG, <span class="params">r</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (mPausingActivity<span class="operator"> == </span>r) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STATES) <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>v(TAG_STATES, <span class="string">"Moving to PAUSED: "</span> + r</span><br><span class="line">                        + (timeout ? <span class="string">" (due to timeout)"</span> : <span class="string">" (pause complete)"</span>));</span><br><span class="line">                complete<span class="constructor">PauseLocked(<span class="params">true</span>, <span class="params">null</span>)</span>;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>调到了内部函数<code>completePauseLocked()</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">complete<span class="constructor">PauseLocked()</span>&#123;</span><br><span class="line">.......</span><br><span class="line">    <span class="keyword">if</span> (resumeNext) &#123;</span><br><span class="line">            final ActivityStack topStack = mStackSupervisor.get<span class="constructor">FocusedStack()</span>;</span><br><span class="line">            <span class="keyword">if</span> (!mService.is<span class="constructor">SleepingOrShuttingDownLocked()</span>) &#123;</span><br><span class="line">                mStackSupervisor.resume<span class="constructor">FocusedStackTopActivityLocked(<span class="params">topStack</span>, <span class="params">prev</span>, <span class="params">null</span>)</span>;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终调了<code>ActivityStackSupervisor</code>里的<code>resumeFocusedStackTopActivityLocked</code>函数.</p>
<h2 id="step10–ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><a href="#step10–ActivityStackSupervisor-resumeFocusedStackTopActivityLocked" class="headerlink" title="step10–ActivityStackSupervisor.resumeFocusedStackTopActivityLocked"></a>step10–ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</h2><p>通过之前流程可以知道，当前在堆栈顶端的Activity为我们即将要启动的Activity,而Launcher对应的Activity已经被paused了。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> resumeFocusedStackTopActivityLocked(</span><br><span class="line">            ActivityStack targetStack, ActivityRecord <span class="keyword">target</span>, ActivityOptions targetOptions) &#123;</span><br><span class="line">        <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> targetStack.<span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(<span class="keyword">target</span>, targetOptions)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="keyword">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">            mFocusedStack.resumeTopActivityUncheckedLocked(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后调用ActivityStack的resumeTopActivityUncheckedLocked()函数.</p>
<h2 id="step10–ActivityStack-resumeTopActivityUncheckedLocked"><a href="#step10–ActivityStack-resumeTopActivityUncheckedLocked" class="headerlink" title="step10–ActivityStack.resumeTopActivityUncheckedLocked"></a>step10–ActivityStack.resumeTopActivityUncheckedLocked</h2><p>在<code>resumeTopActivityUncheckedLocked</code>函数里调了自身的<code>resumeTopActivityInnerLocked</code>,然后调自身的<code>resumeTopActivityInnerLocked</code>,最终调了<code>mStackSupervisor.startSpecificActivityLocked(next, true, true)</code>.</p>
<h2 id="step11–ActivityStackSupervisor-startSpecificActivityLocked"><a href="#step11–ActivityStackSupervisor-startSpecificActivityLocked" class="headerlink" title="step11–ActivityStackSupervisor.startSpecificActivityLocked"></a>step11–ActivityStackSupervisor.startSpecificActivityLocked</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mService.startProcessLocked(r.processName,</span> <span class="string">r.info.applicationInfo,</span> <span class="literal">true</span><span class="string">,</span> <span class="number">0</span><span class="string">,</span></span><br><span class="line">                <span class="string">"activity"</span><span class="string">,</span> <span class="string">r.intent.getComponent(),</span> <span class="literal">false</span><span class="string">,</span> <span class="literal">false</span><span class="string">,</span> <span class="literal">true</span><span class="string">);</span></span><br></pre></td></tr></table></figure>

<p>调到了<code>ActivityManagerService</code>里.</p>
<h2 id="step12–ActivityManagerService-startProcessLocked"><a href="#step12–ActivityManagerService-startProcessLocked" class="headerlink" title="step12–ActivityManagerService.startProcessLocked"></a>step12–ActivityManagerService.startProcessLocked</h2><p>此函数里核心代码如下:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">check<span class="constructor">Time(<span class="params">startTime</span>, <span class="string">"startProcess: asking zygote to start proc"</span>)</span>;</span><br><span class="line">            Process.ProcessStartResult startResult = <span class="module-access"><span class="module"><span class="identifier">Process</span>.</span></span>start(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, entryPointArgs);</span><br><span class="line">            check<span class="constructor">Time(<span class="params">startTime</span>, <span class="string">"startProcess: returned from zygote!"</span>)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="step13–Process-start"><a href="#step13–Process-start" class="headerlink" title="step13–Process.start()"></a>step13–Process.start()</h2><p>最终来到了Process(<code>./frameworks/base/core/java/android/os/Process.java</code>),调用自身<code>startViaZygote()</code>,在这个函数里最后一句是:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return zygoteSendArgsAndGetResult(<span class="name">openZygoteSocketIfNeeded</span>(<span class="name">abi</span>), argsForZygote)<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>首先通过<code>openZygoteSocketIfNeeded</code>,建AMS进程和Zygote进程通过socket进行跨进程通信的连接.<br>然后<code>zygoteSendArgsAndGetResult()</code>这个函数向zygote进程发送一个参数列表，zygote进程会启动一个新的子进程并返回该子进程的pid号。<br>请求的参数中有一个字符串，它的值是“android.app.ActivityThread”。现在该回到zygote处理请求那块去看看了——就是runSelectLoop函数，具体在<code>ZygoteInit</code>里：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> void runSelectLoop(<span class="keyword">String</span> abiList) throws MethodAndArgsCaller &#123;</span><br><span class="line">.........</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            StructPollfd[] pollFds = <span class="keyword">new</span> <span class="type">StructPollfd</span>[fds.size()];</span><br><span class="line">            <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">                pollFds[i] = <span class="keyword">new</span> <span class="type">StructPollfd</span>();</span><br><span class="line">                pollFds[i].fd = fds.<span class="keyword">get</span>(i);</span><br><span class="line">                pollFds[i].events = (short) POLLIN;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Os.poll(pollFds, <span class="number">-1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RuntimeException</span>(<span class="string">"poll failed"</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (int i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                    ZygoteConnection <span class="keyword">new</span><span class="type">Peer</span> = acceptCommandPeer(abiList);</span><br><span class="line">                    peers.add(<span class="keyword">new</span><span class="type">Peer</span>);</span><br><span class="line">                    fds.add(<span class="keyword">new</span><span class="type">Peer</span>.getFileDesciptor());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    boolean done = peers.<span class="keyword">get</span>(i).runOnce();</span><br><span class="line">                    <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                        peers.remove(i);</span><br><span class="line">                        fds.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到里面是一个while循环，一直在监听socket发来的信息，最终调用了<code>ZygoteConnection</code>里的<code>runOnce</code>函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</span><br><span class="line">                    parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</span><br><span class="line">                    parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</span><br><span class="line">                    parsedArgs.appDataDir);</span><br><span class="line">        &#125;</span><br><span class="line">.......</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// in child</span></span><br><span class="line">                IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">                serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line">                handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// should never get here, the child is expected to either</span></span><br><span class="line">                <span class="comment">// throw ZygoteInit.MethodAndArgsCaller or exec().</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>这里最终调到了Zygote的两个关键函数<code>forkAndSpecialize</code>函数，然后通过JNI调用了<code>nativeForkAndSpecialize</code>函数,这个函数最终fork了一个子进程,暂时忽略.<br>另外一个函数是<code>handleChildProc()</code>：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (parsedArgs.invokeWith != <span class="built_in">null</span>) &#123;</span><br><span class="line">           WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">                   parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">                   VMRuntime.getCurrentInstructionSet(),</span><br><span class="line">                   pipeFd, parsedArgs.remainingArgs);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,</span><br><span class="line">                   parsedArgs.remainingArgs, <span class="built_in">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里会走到<code>RuntimeInit.zygoteInit</code>,然后调内部的<code>applicationInit()</code>函数,再调内部的<code>invokeStaticMain()</code>函数:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> invokeStaticMain(String className, String[] argv, ClassLoader classLoader)</span><br><span class="line">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</span><br><span class="line">        <span class="keyword">Class</span>&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cl = <span class="keyword">Class</span>.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">        &#125; </span><br><span class="line">......</span><br><span class="line">        Method m;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> <span class="keyword">Class</span>[] &#123; String[].<span class="keyword">class</span> &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Missing static main on "</span> + className, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，上述代码完成了一个反射的功能，去加载传进来的类名的<code>main</code>方法。在打开应用过程中，这个类名就是<code>android.app.ActivityThread</code></p>
<h2 id="step14–ActivityThread-main"><a href="#step14–ActivityThread-main" class="headerlink" title="step14–ActivityThread.main()"></a>step14–ActivityThread.main()</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String<span class="literal">[]</span> args) &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">SamplingProfilerIntegration</span>.</span></span>start<span class="literal">()</span>;</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Process</span>.</span></span>set<span class="constructor">ArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Looper</span>.</span></span>prepare<span class="constructor">MainLooper()</span>;</span><br><span class="line"></span><br><span class="line">        ActivityThread thread = <span class="keyword">new</span> <span class="constructor">ActivityThread()</span>;</span><br><span class="line">        thread.attach(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sMainThreadHandler<span class="operator"> == </span>null) &#123;</span><br><span class="line">            sMainThreadHandler = thread.get<span class="constructor">Handler()</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br></pre></td></tr></table></figure>

<p>在main函数里，创建了<code>ActivityThread</code>和主Ui线程Handler,然后调用它的attach函数:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final IActivityManager mgr = <span class="module-access"><span class="module"><span class="identifier">ActivityManagerNative</span>.</span></span>get<span class="constructor">Default()</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.attach<span class="constructor">Application(<span class="params">mAppThread</span>)</span>;</span><br><span class="line">            &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                throw ex.rethrow<span class="constructor">FromSystemServer()</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>mgr</code>就是<code>ActivityManagerService</code>的远程接口<code>ActivityManagerProxy</code>的<code>attachApplication</code>函数.</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">public</span> void attachApplication(<span class="type">IApplicationThread</span> app) throws <span class="type">RemoteException</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="type">Parcel</span> <span class="class"><span class="keyword">data</span> = <span class="type">Parcel</span>.obtain();</span></span><br><span class="line">       <span class="type">Parcel</span> reply = <span class="type">Parcel</span>.obtain();</span><br><span class="line">       <span class="class"><span class="keyword">data</span>.writeInterfaceToken(<span class="type">IActivityManager</span>.<span class="title">descriptor</span>);</span></span><br><span class="line">       <span class="class"><span class="keyword">data</span>.writeStrongBinder(<span class="title">app</span>.<span class="title">asBinder</span>());</span></span><br><span class="line">       mRemote.transact(<span class="type">ATTACH_APPLICATION_TRANSACTION</span>, <span class="class"><span class="keyword">data</span>, reply, 0);</span></span><br><span class="line">       reply.readException();</span><br><span class="line">       <span class="class"><span class="keyword">data</span>.recycle();</span></span><br><span class="line">       reply.recycle();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里传进来的参数就是刚刚创建进程的远程调用接口,将其传给AMS。通过跨进程通讯，来到了<code>ActivityManagerService</code>的<code>attachApplication</code>函数。</p>
<h2 id="step15–ActivityManagerService-attachApplication"><a href="#step15–ActivityManagerService-attachApplication" class="headerlink" title="step15–ActivityManagerService.attachApplication()"></a>step15–ActivityManagerService.attachApplication()</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (mStackSupervisor.attach<span class="constructor">ApplicationLocked(<span class="params">app</span>)</span>) &#123;</span><br><span class="line">                   didSomething = <span class="literal">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>wtf(TAG, <span class="string">"Exception thrown launching activities in "</span> + app, e);</span><br><span class="line">               badApp = <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里进到了<code>attachApplicationLocked</code>函数.</p>
<h2 id="step16–ActivityStackSupervisor-attachApplicationLocked"><a href="#step16–ActivityStackSupervisor-attachApplicationLocked" class="headerlink" title="step16–ActivityStackSupervisor.attachApplicationLocked()"></a>step16–ActivityStackSupervisor.attachApplicationLocked()</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ActivityRecord <span class="attr">hr</span> = stack.topRunningActivityLocked();</span><br><span class="line">                <span class="keyword">if</span> (hr != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (hr.<span class="attr">app</span> == <span class="literal">null</span> &amp;&amp; app.<span class="attr">uid</span> == hr.info.applicationInfo.uid</span><br><span class="line">                            &amp;&amp; processName.equals(hr.processName)) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="literal">true</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">                                <span class="attr">didSomething</span> = <span class="literal">true</span>;</span><br><span class="line">                            .....</span><br></pre></td></tr></table></figure>

<p>这里先调ActivityStack的topRunningActivityLocked，然后再调自己的<code>realStartActivityLocked</code>:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.thread.schedule<span class="constructor">LaunchActivity(<span class="params">new</span> Intent(<span class="params">r</span>.<span class="params">intent</span>)</span>, r.appToken,</span><br><span class="line">                    <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>identity<span class="constructor">HashCode(<span class="params">r</span>)</span>, r.info, <span class="keyword">new</span> <span class="constructor">Configuration(<span class="params">mService</span>.<span class="params">mConfiguration</span>)</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="constructor">Configuration(<span class="params">task</span>.<span class="params">mOverrideConfig</span>)</span>, r.compat, r.launchedFromPackage,</span><br><span class="line">                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                    newIntents, !andResume, mService.is<span class="constructor">NextTransitionForward()</span>, profilerInfo);</span><br></pre></td></tr></table></figure>

<p>这里app.thread最终进到了<code>ApplicationThreadProxy</code>的<code>scheduleLaunchActivity</code>函数中。</p>
<h2 id="step17–ApplicationThreadProxy-scheduleLaunchActivity"><a href="#step17–ApplicationThreadProxy-scheduleLaunchActivity" class="headerlink" title="step17–ApplicationThreadProxy.scheduleLaunchActivity()"></a>step17–ApplicationThreadProxy.scheduleLaunchActivity()</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">mRemote</span><span class="selector-class">.transact</span>(<span class="selector-tag">SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION</span>, <span class="selector-tag">data</span>, <span class="selector-tag">null</span>,</span><br><span class="line">               <span class="selector-tag">IBinder</span><span class="selector-class">.FLAG_ONEWAY</span>);</span><br></pre></td></tr></table></figure>

<p>AMS通过Binder通信，告诉<code>SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION</code>，进到了<code>scheduleLaunchActivity</code></p>
<h2 id="step18–ApplicationThreadProxy-scheduleLaunchActivity"><a href="#step18–ApplicationThreadProxy-scheduleLaunchActivity" class="headerlink" title="step18–ApplicationThreadProxy.scheduleLaunchActivity()"></a>step18–ApplicationThreadProxy.scheduleLaunchActivity()</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public final void schedule<span class="constructor">LaunchActivity(Intent <span class="params">intent</span>, IBinder <span class="params">token</span>, <span class="params">int</span> <span class="params">ident</span><span class="operator">...</span>)</span></span><br><span class="line">      send<span class="constructor">Message(H.LAUNCH_ACTIVITY, <span class="params">r</span>)</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>来到了Handler(H)的handleMessage函数里：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">LAUNCH_ACTIVITY:</span> &#123;</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">                    <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">                    r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                            r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">                    handleLaunchActivity(r, <span class="literal">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                &#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>调用自己的<code>handleLaunchActivity</code>:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="literal">void</span> handleLaunchActivity(ActivityClientRecord r, Intent customIntent, <span class="built_in">String</span> reason) &#123;</span><br><span class="line"><span class="params">...</span><span class="params">...</span></span><br><span class="line">        Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">        <span class="keyword">if</span> (a != <span class="built_in">null</span>) &#123;</span><br><span class="line">           <span class="params">...</span>..</span><br><span class="line">            handleResumeActivity(r.token, <span class="literal">false</span>, r.isForward,</span><br><span class="line">                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line">                    <span class="params">...</span>.</span><br><span class="line">                performPauseActivityIfNeeded(r, reason);</span><br></pre></td></tr></table></figure>

<p>在<code>handleLaunchActivity</code>函数里主要干了两个重要事情,第一是通过<code>performLaunchActivity</code>去加载一个<code>Activity</code>,然后调用它的<code>onCreate</code>方法:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="literal">null</span>) &#123;</span><br><span class="line">            component = new ComponentName(r.activityInfo.packageName,</span><br><span class="line">                    r.activityInfo.targetActivity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Activity activity = <span class="literal">null</span>;</span><br><span class="line">        try &#123;</span><br><span class="line">            java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">        &#125; <span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">        try &#123;</span><br><span class="line">            Application app = r.packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">                Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                Configuration<span class="built_in"> config </span>= new Configuration(mCompatConfiguration);</span><br><span class="line">               <span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">                activity.attach(appContext, this, getInstrumentation(), r)</span><br><span class="line">                <span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>performLaunchActivity</code>函数里，先通过类加载器创建一个<code>Activity</code>对象，然后创建<code>Application</code>对象,调用<code>Activity</code>的<code>attach()</code>,再通过<code>mInstrumentation.callActivityOnCreate</code>调Activity的<code>onCreate</code>。然后回到<code>handleLaunchActivity</code>函数，执行<code>handleResumeActivity</code>,即调Activity的<code>onResume()</code>生命周期。终于，新打开的<code>Activity</code>启动起来了!!!</p>
<h2 id="过程总结"><a href="#过程总结" class="headerlink" title="过程总结"></a>过程总结</h2><p>整个应用程序的启动过程要执行很多步骤，但是整体来看，主要分为以下五个阶段：</p>
<ol>
<li><p>Launcher通过Binder进程间通信机制通知AMS，它要启动一个Activity；</p>
</li>
<li><p>AMS通过Binder进程间通信机制通知Launcher进入Paused状态；</p>
</li>
<li><p>Launcher通过Binder进程间通信机制通知AMS它已经准备就绪进入Paused状态，于是AMS就创建一个新的进程，用来启动一个ActivityThread实例，即将要启动的Activity就是在这个ActivityThread实例中运行；</p>
</li>
<li><p>ActivityThread通过Binder进程间通信机制将一个ApplicationThread类型的Binder对象传递给AMS，以便以后AMS能够通过这个Binder对象和它进行通信；</p>
</li>
<li><p>AMS通过Binder进程间通信机制通知ActivityThread，现在一切准备就绪，它可以真正执行Activity的启动操作了。</p>
</li>
</ol>
<h2 id="调用流程图"><a href="#调用流程图" class="headerlink" title="调用流程图"></a>调用流程图</h2><p><img src="http://image.yangq.me/blog/history/16-7-5/activityStart.png" alt></p>

    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/Android/" rel="tag"># Android</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/post/170b145.html" rel="prev" title="在Vultr Debian7上搭建科学上网，使用锐速畅享十倍提速">
                  在Vultr Debian7上搭建科学上网，使用锐速畅享十倍提速 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="gitalk-container"></div>
  

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#step3–Instrumentation-execStartActivity"><span class="nav-number">1.</span> <span class="nav-text">step3–Instrumentation.execStartActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step4–ActivityManagerProxy-startActivity"><span class="nav-number">2.</span> <span class="nav-text">step4–ActivityManagerProxy.startActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step4–ActivityManagerService-startActivity"><span class="nav-number">3.</span> <span class="nav-text">step4–ActivityManagerService.startActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step5–ActivityStarter-startActivityMayWait"><span class="nav-number">4.</span> <span class="nav-text">step5–ActivityStarter.startActivityMayWait</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step6–ApplicationThreadProxy-schedulePauseActivity"><span class="nav-number">5.</span> <span class="nav-text">step6–ApplicationThreadProxy.schedulePauseActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step7–ApplicationThread-schedulePauseActivity"><span class="nav-number">6.</span> <span class="nav-text">step7–ApplicationThread.schedulePauseActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step8–ActivityManagerService-activityPaused"><span class="nav-number">7.</span> <span class="nav-text">step8–ActivityManagerService.activityPaused</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step9–ActivityStack-activityPausedLocked"><span class="nav-number">8.</span> <span class="nav-text">step9–ActivityStack.activityPausedLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step10–ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><span class="nav-number">9.</span> <span class="nav-text">step10–ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step10–ActivityStack-resumeTopActivityUncheckedLocked"><span class="nav-number">10.</span> <span class="nav-text">step10–ActivityStack.resumeTopActivityUncheckedLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step11–ActivityStackSupervisor-startSpecificActivityLocked"><span class="nav-number">11.</span> <span class="nav-text">step11–ActivityStackSupervisor.startSpecificActivityLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step12–ActivityManagerService-startProcessLocked"><span class="nav-number">12.</span> <span class="nav-text">step12–ActivityManagerService.startProcessLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step13–Process-start"><span class="nav-number">13.</span> <span class="nav-text">step13–Process.start()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step14–ActivityThread-main"><span class="nav-number">14.</span> <span class="nav-text">step14–ActivityThread.main()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step15–ActivityManagerService-attachApplication"><span class="nav-number">15.</span> <span class="nav-text">step15–ActivityManagerService.attachApplication()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step16–ActivityStackSupervisor-attachApplicationLocked"><span class="nav-number">16.</span> <span class="nav-text">step16–ActivityStackSupervisor.attachApplicationLocked()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step17–ApplicationThreadProxy-scheduleLaunchActivity"><span class="nav-number">17.</span> <span class="nav-text">step17–ApplicationThreadProxy.scheduleLaunchActivity()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step18–ApplicationThreadProxy-scheduleLaunchActivity"><span class="nav-number">18.</span> <span class="nav-text">step18–ApplicationThreadProxy.scheduleLaunchActivity()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过程总结"><span class="nav-number">19.</span> <span class="nav-text">过程总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调用流程图"><span class="nav-number">20.</span> <span class="nav-text">调用流程图</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.jpg"
      alt="老实念佛">
  <p class="site-author-name" itemprop="name">老实念佛</p>
  <div class="site-description" itemprop="description">小小程序员</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">老实念佛</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.0</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '60d9686c526081007639',
      clientSecret: '2cb744c4370e936e30bcd161c1c142fadabe6d46',
      repo: 'blogcomments',
      owner: 'yangq212607',
      admin: ['yangq212607'],
      id: '60512c00f0e6096a27612d4ccec6a4d0',
        language: 'zh-CN',
      
      distractionFreeMode: 'true'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
</script>

</body>
</html>
