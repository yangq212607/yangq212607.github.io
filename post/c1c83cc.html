<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"default"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="ActivityThread是Activity里一个很重要的成员变量，俗称UI线程，也即应用的主线程,它自身有三个比较关键的成员变量，其中之一是ApplicationThread,在ActivityThread创建的时候作为全局变量被创建: 1234final ApplicationThread mAppThread = new ApplicationThread();final Applicat">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android应用启动流程分析">
<meta property="og:url" content="http://yangq.me/post/c1c83cc.html">
<meta property="og:site_name" content="yangq&#39;s blog">
<meta property="og:description" content="ActivityThread是Activity里一个很重要的成员变量，俗称UI线程，也即应用的主线程,它自身有三个比较关键的成员变量，其中之一是ApplicationThread,在ActivityThread创建的时候作为全局变量被创建: 1234final ApplicationThread mAppThread = new ApplicationThread();final Applicat">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://image.yangq.me/blog/history/16-7-5/activityStart.png">
<meta property="og:updated_time" content="2019-09-17T16:42:06.926Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android应用启动流程分析">
<meta name="twitter:description" content="ActivityThread是Activity里一个很重要的成员变量，俗称UI线程，也即应用的主线程,它自身有三个比较关键的成员变量，其中之一是ApplicationThread,在ActivityThread创建的时候作为全局变量被创建: 1234final ApplicationThread mAppThread = new ApplicationThread();final Applicat">
<meta name="twitter:image" content="http://image.yangq.me/blog/history/16-7-5/activityStart.png">
  <link rel="canonical" href="http://yangq.me/post/c1c83cc">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Android应用启动流程分析 | yangq's blog</title>
  <meta name="generator" content="Hexo 3.9.0">
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yangq's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">观心中月,破心中贼</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">35</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">6</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">8</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yangq.me/post/c1c83cc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="老实念佛">
      <meta itemprop="description" content="小小程序员">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangq's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Android应用启动流程分析

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2017-02-12 17:31:43" itemprop="dateCreated datePublished" datetime="2017-02-12T17:31:43+08:00">2017-02-12</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-18 00:42:06" itemprop="dateModified" datetime="2019-09-18T00:42:06+08:00">2019-09-18</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a></span>

                
                
              
            </span>
          

          
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><code>ActivityThread</code>是<code>Activity</code>里一个很重要的成员变量，俗称UI线程，也即应用的主线程,它自身有三个比较关键的成员变量，其中之一是<code>ApplicationThread</code>,在<code>ActivityThread</code>创建的时候作为全局变量被创建:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">final ApplicationThread mAppThread = new ApplicationThread();</span><br><span class="line">final ApplicationThread mAppThread = new ApplicationThread();</span><br><span class="line">final Looper mLooper = Looper.myLooper();</span><br><span class="line">final H mH = new H();</span><br></pre></td></tr></table></figure>

<a id="more"></a>
<p><code>ApplicationThread</code>是<code>ActivityThread</code>里一个内部类，继承自<code>ApplicationThreadNative</code>,而<code>ApplicationThreadNative</code>又继承自<code>Binder</code>并<strong>implements</strong>了<code>IApplicationThread</code>接口(此处并没有真正实现)，<code>IApplicationThread</code>继承<code>IInterface</code>,定义了一系列操作应用的接口，用来和AMS进行通信,其中和Activity生命周期相关的几个关键函数如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void schedulePauseActivity(IBinder token, boolean finished, boolean userLeaving,int configChanges, boolean dontReport) throws RemoteException;</span><br><span class="line"></span><br><span class="line">void scheduleStopActivity(IBinder token, boolean showWindow,int configChanges) throws RemoteException;</span><br><span class="line"></span><br><span class="line">void scheduleResumeActivity(IBinder token, int procState, boolean isForward, Bundle resumeArgs)throws RemoteException;</span><br></pre></td></tr></table></figure>

<p><code>IInterface.java</code>代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public interface IInterface</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * Retrieve the Binder object associated with this interface.</span><br><span class="line">     * You must use this instead of a plain cast, so that proxy objects</span><br><span class="line">     * can return the correct result.</span><br><span class="line">     */</span><br><span class="line">    public IBinder asBinder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Binder.java</code>实现了<code>IBinder</code>接口，核心的<code>onTransact</code>函数和<code>transact</code>代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">protected boolean onTransact(int code, Parcel data, Parcel reply,</span><br><span class="line">            int flags) throws RemoteException &#123;</span><br><span class="line">        if (code == INTERFACE_TRANSACTION) &#123;</span><br><span class="line">            reply.writeString(getInterfaceDescriptor());</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else if (code == DUMP_TRANSACTION) &#123;</span><br><span class="line">            ParcelFileDescriptor fd = data.readFileDescriptor();</span><br><span class="line">            String[] args = data.readStringArray();</span><br><span class="line">            if (fd != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    dump(fd.getFileDescriptor(), args);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    IoUtils.closeQuietly(fd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    ........</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public final boolean transact(int code, Parcel data, Parcel reply,</span><br><span class="line">          int flags) throws RemoteException &#123;</span><br><span class="line">      if (false) Log.v(&quot;Binder&quot;, &quot;Transact: &quot; + code + &quot; to &quot; + this);</span><br><span class="line"></span><br><span class="line">      if (data != null) &#123;</span><br><span class="line">          data.setDataPosition(0);</span><br><span class="line">      &#125;</span><br><span class="line">      boolean r = onTransact(code, data, reply, flags);</span><br><span class="line">      if (reply != null) &#123;</span><br><span class="line">          reply.setDataPosition(0);</span><br><span class="line">      &#125;</span><br><span class="line">      return r;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>注意上面的<code>transact()</code>函数是<strong>final</strong>修饰，不可被子类重写，但<code>onTransact()</code>可以被重写。<br><code>ApplicationThreadNative</code>的主要功能就是重写了<code>onTransact</code>函数，根据不同的<code>code</code>路由给内部类<code>ApplicationThreadProxy</code>(实现了<code>IApplicationThread</code>接口),完成和binder通讯的部分.<br>也即真正实现<code>IApplicationThread</code>接口的有两个类：<code>ApplicationThread</code>和<code>ApplicationThreadProxy</code>,其中<code>ApplicationThread</code>负责通过<code>ActivityThread</code>最终控制<code>Activity</code>的生命周期，<code>ApplicationThreadProxy</code>负责对应功能与Binder通讯的部门。<br>也可以说<code>ApplicationThread</code>具有上面两部分功能，只不过按层次实现在不同类里.</p>
<p>以<code>schedulePauseActivity()</code>接口为例，<code>ApplicationThreadProxy</code>实现为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public final void schedulePauseActivity(IBinder token, boolean finished,</span><br><span class="line">        boolean userLeaving, int configChanges, boolean dontReport) throws RemoteException &#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    data.writeInt(finished ? 1 : 0);</span><br><span class="line">    data.writeInt(userLeaving ? 1 :0);</span><br><span class="line">    data.writeInt(configChanges);</span><br><span class="line">    data.writeInt(dontReport ? 1 : 0);</span><br><span class="line">    mRemote.transact(SCHEDULE_PAUSE_ACTIVITY_TRANSACTION, data, null,</span><br><span class="line">            IBinder.FLAG_ONEWAY);</span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ApplicationThread</code>对其实现为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public final void schedulePauseActivity(IBinder token, boolean finished,</span><br><span class="line">        boolean userLeaving, int configChanges, boolean dontReport) &#123;</span><br><span class="line">    int seq = getLifecycleSeq();</span><br><span class="line">    if (DEBUG_ORDER) Slog.d(TAG, &quot;pauseActivity &quot; + ActivityThread.this</span><br><span class="line">            + &quot; operation received seq: &quot; + seq);</span><br><span class="line">    sendMessage(</span><br><span class="line">            finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</span><br><span class="line">            token,</span><br><span class="line">            (userLeaving ? USER_LEAVING : 0) | (dontReport ? DONT_REPORT : 0),</span><br><span class="line">            configChanges,</span><br><span class="line">            seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中sendMessage实现为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) &#123;</span><br><span class="line">    if (DEBUG_MESSAGES) Slog.v(</span><br><span class="line">        TAG, &quot;SCHEDULE &quot; + what + &quot; &quot; + mH.codeToString(what)</span><br><span class="line">        + &quot;: &quot; + arg1 + &quot; / &quot; + obj);</span><br><span class="line">    Message msg = Message.obtain();</span><br><span class="line">    msg.what = what;</span><br><span class="line">    msg.obj = obj;</span><br><span class="line">    msg.arg1 = arg1;</span><br><span class="line">    msg.arg2 = arg2;</span><br><span class="line">    if (async) &#123;</span><br><span class="line">        msg.setAsynchronous(true);</span><br><span class="line">    &#125;</span><br><span class="line">    mH.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mH继承自<code>Handler</code>负责处理ApplicationThread发送到消息队列的消息，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public void handleMessage(Message msg) &#123;</span><br><span class="line">         if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what));</span><br><span class="line">         switch (msg.what) &#123;</span><br><span class="line">             case LAUNCH_ACTIVITY: &#123;</span><br><span class="line">                 Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityStart&quot;);</span><br><span class="line">                 final ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">                 r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                         r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">                 handleLaunchActivity(r, null, &quot;LAUNCH_ACTIVITY&quot;);</span><br><span class="line">                 Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">             &#125; break;</span><br><span class="line">       .........</span><br></pre></td></tr></table></figure>

<p>上面把<code>ActivityThread</code>、<code>ApplicationThread</code>、<code>ApplicationThreadProxy</code>、<code>ApplicationThreadNative</code>的关系说清楚了，下面接着看流程.</p>
<h2 id="step3–Instrumentation-execStartActivity"><a href="#step3–Instrumentation-execStartActivity" class="headerlink" title="step3–Instrumentation.execStartActivity"></a>step3–Instrumentation.execStartActivity</h2><p><code>Instrumentation</code>里的<code>execStartActivity()</code>核心代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public ActivityResult execStartActivity(</span><br><span class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">        Intent intent, int requestCode, Bundle options) &#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    Uri referrer = target != null ? target.onProvideReferrer() : null;</span><br><span class="line">      .........</span><br><span class="line">    try &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess(who);</span><br><span class="line">        int result = ActivityManagerNative.getDefault()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, target != null ? target.mEmbeddedID : null,</span><br><span class="line">                    requestCode, 0, null, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;Failure from system&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最关键的是<code>int result = ActivityManagerNative.getDefault().startActivity(...)</code>,<code>ActivityManagerNative</code>在路径:<code>/frameworks/base/core/java/android/app/ActivityManagerNative.java</code>,其中的<code>getDefault()</code>函数返回内部的变量:<code>gDefault</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private static final Singleton&lt;IActivityManager&gt; gDefault = new Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">    protected IActivityManager create() &#123;</span><br><span class="line">            IBinder b = ServiceManager.getService(&quot;activity&quot;);</span><br><span class="line">            if (false) &#123;</span><br><span class="line">                Log.v(&quot;ActivityManager&quot;, &quot;default service binder = &quot; + b);</span><br><span class="line">            &#125;</span><br><span class="line">            IActivityManager am = asInterface(b);</span><br><span class="line">            if (false) &#123;</span><br><span class="line">                Log.v(&quot;ActivityManager&quot;, &quot;default service = &quot; + am);</span><br><span class="line">            &#125;</span><br><span class="line">            return am;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ServiceManager</code>路径<code>/frameworks/base/core/java/android/os/ServiceManager.java</code>,它就是Android的ServiceManager进程，本身也是一个服务，内部通过一个HashMap类型<code>sCache</code>变量保存各种Service的Binder接口,如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private static HashMap&lt;String, IBinder&gt; sCache = new HashMap&lt;String, IBinder&gt;();</span><br><span class="line"></span><br><span class="line">public static IBinder getService(String name) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            IBinder service = sCache.get(name);</span><br><span class="line">            if (service != null) &#123;</span><br><span class="line">                return service;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return getIServiceManager().getService(name);</span><br><span class="line">            &#125;</span><br><span class="line"> .........</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">public static void addService(String name, IBinder service) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            getIServiceManager().addService(name, service, false);</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            Log.e(TAG, &quot;error in addService&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>从中可以看到gDefault实质是ActivityManagerService的远程接口,然后通过<code>asInterface</code>这个函数将一个Binder对象转为IActivityManager接口，并生成了一个<code>ActivityManagerProxy</code>对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Cast a Binder object into an activity manager interface, generating</span><br><span class="line">  * a proxy if needed.</span><br><span class="line">  */</span><br><span class="line"> static public IActivityManager asInterface(IBinder obj) &#123;</span><br><span class="line">     if (obj == null) &#123;</span><br><span class="line">         return null;</span><br><span class="line">     &#125;</span><br><span class="line">     IActivityManager in =</span><br><span class="line">         (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">     if (in != null) &#123;</span><br><span class="line">         return in;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     return new ActivityManagerProxy(obj);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>所以最终又调到了ActivityManagerProxy.startActivity函数.<br>这里<code>ActivityManagerNative</code>和<code>ActivityManagerProxy</code>,与<code>ApplicationThreadNative</code>和<code>ApplicationThreadProxy</code>在实现模式上是一样的。</p>
<h2 id="step4–ActivityManagerProxy-startActivity"><a href="#step4–ActivityManagerProxy-startActivity" class="headerlink" title="step4–ActivityManagerProxy.startActivity"></a>step4–ActivityManagerProxy.startActivity</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class ActivityManagerProxy implements IActivityManager</span><br><span class="line">&#123;</span><br><span class="line">    public ActivityManagerProxy(IBinder remote)</span><br><span class="line">    &#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int startActivity(IApplicationThread caller, String callingPackage, Intent intent,</span><br><span class="line">            String resolvedType, IBinder resultTo, String resultWho, int requestCode,</span><br><span class="line">            int startFlags, ProfilerInfo profilerInfo, Bundle options) throws RemoteException &#123;</span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">        data.writeStrongBinder(caller != null ? caller.asBinder() : null);</span><br><span class="line">        ......data.writeString(callingPackage);</span><br><span class="line">        intent.writeToParcel(data, 0);</span><br><span class="line">        ...</span><br><span class="line">        mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, 0);</span><br><span class="line">        reply.readException();</span><br><span class="line">        int result = reply.readInt();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面说过在ActivityManagerProxy被创建的时候传进来一个IBinder对象，这个就是AMS的远程调用接口，也即<code>mRemote</code>变量.这里最核心的一句是:<code>mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, 0)</code>。</p>
<h2 id="step4–ActivityManagerService-startActivity"><a href="#step4–ActivityManagerService-startActivity" class="headerlink" title="step4–ActivityManagerService.startActivity"></a>step4–ActivityManagerService.startActivity</h2><p>上个步骤里的mRemote.transact()就是利用binder驱动进行跨进程通信的过程，在mRemote的onTransact函数里一定有个地方去响应<code>START_ACTIVITY_TRANSACTION</code>这个命令。</p>
<p><strong>注意:上面的步骤都是在初始应用程序A进程里，在onTransact时来到了AMS，也即AMS所在的SystemServer进程.</strong></p>
<p>我们直接到<code>ActivityManagerService</code>里去找.<br>源码在<code>/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code>,它继承了上面的<code>ActivityManagerNative</code>,在其<code>onTransact</code>函数里找到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public boolean onTransact(int code, Parcel data, Parcel reply, int flags)</span><br><span class="line">            throws RemoteException &#123;</span><br><span class="line">        switch (code) &#123;</span><br><span class="line">        case START_ACTIVITY_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">            IBinder b = data.readStrongBinder();</span><br><span class="line">            IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line">            String callingPackage = data.readString();</span><br><span class="line">           .............</span><br><span class="line">            int result = startActivity(........);</span><br><span class="line">            reply.writeNoException();</span><br><span class="line">            reply.writeInt(result);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这里又调用了<code>startActivity</code>函数，但是<code>ActivityManagerNative</code>是个abstract类，并没有真正实现<code>IActivityManager</code>接口，其实现在其子类<code>ActivityManagerService</code>里。它又调了内部的<code>startActivityAsUser()</code>函数,最终又进到<code>mActivityStarter.startActivityMayWait()</code>函数里。</p>
<h2 id="step5–ActivityStarter-startActivityMayWait"><a href="#step5–ActivityStarter-startActivityMayWait" class="headerlink" title="step5–ActivityStarter.startActivityMayWait"></a>step5–ActivityStarter.startActivityMayWait</h2><p><strong>备注:此处往下的流程集中在<code>ActivityStackSupervisor</code>、<code>ActivityStack</code>、<code>ActivityStarter</code>比较复杂，只交代调用流程，不作太多解释.</strong><br><code>startActivityMayWait()</code>这个函数比较长，最终又调了内部的<code>startActivityLocked</code>里。<br>doPendingActivityLaunchesLocked—startActivityUnchecked,在<code>startActivityUnchecked</code>通过<code>mSupervisor.resumeFocusedStackTopActivityLocked()</code>,进到<code>ActivityStackSupervisor</code>,然后进到<code>ActivityStack.resumeTopActivityUncheckedLocked</code>,再调内部的<code>resumeTopActivityInnerLocked()</code>函数，再调内部的<code>startPausingLocked</code>函数,其中关键一句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                        userLeaving, prev.configChangeFlags, dontWait);</span><br></pre></td></tr></table></figure>

<p>这里<code>prev</code>类型为<code>ActivityRecord</code>,<code>app</code>类型为<code>ProcessRecord</code>,<code>thread</code>类型为<code>IApplicationThread</code>,即<code>prev.app.thread</code>是运行在<code>ActivityManagerService</code>进程里的``ApplicationThread<code>的远程调用接口</code>ApplicationThreadProxy`.</p>
<h2 id="step6–ApplicationThreadProxy-schedulePauseActivity"><a href="#step6–ApplicationThreadProxy-schedulePauseActivity" class="headerlink" title="step6–ApplicationThreadProxy.schedulePauseActivity"></a>step6–ApplicationThreadProxy.schedulePauseActivity</h2><p>代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      boolean userLeaving, int configChanges, boolean dontReport) throws RemoteException &#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">    ..........</span><br><span class="line">    data.writeInt(dontReport ? 1 : 0);</span><br><span class="line">    mRemote.transact(SCHEDULE_PAUSE_ACTIVITY_TRANSACTION, data, null,</span><br><span class="line">            IBinder.FLAG_ONEWAY);</span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过进程间通信，来到<code>ApplicationThreadNative</code>里的<code>onTransact</code>函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public boolean onTransact(int code, Parcel data, Parcel reply, int flags)</span><br><span class="line">            throws RemoteException &#123;</span><br><span class="line">        switch (code) &#123;</span><br><span class="line">        case SCHEDULE_PAUSE_ACTIVITY_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            data.enforceInterface(IApplicationThread.descriptor);</span><br><span class="line">            IBinder b = data.readStrongBinder();</span><br><span class="line">            ......</span><br><span class="line">            schedulePauseActivity(b, finished, userLeaving, configChanges, dontReport);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="step7–ApplicationThread-schedulePauseActivity"><a href="#step7–ApplicationThread-schedulePauseActivity" class="headerlink" title="step7–ApplicationThread.schedulePauseActivity"></a>step7–ApplicationThread.schedulePauseActivity</h2><p><strong>注意:经过上面步骤里的onTransact来到了Launcher进程里.</strong><br><code>schedulePauseActivity()</code>通过<code>ActivityThread</code>里的Handler<code>mH</code>,将消息转发至UI线程里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">case PAUSE_ACTIVITY: &#123;</span><br><span class="line">                  Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityPause&quot;);</span><br><span class="line">                  SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">                  handlePauseActivity((IBinder) args.arg1, false,</span><br><span class="line">                          (args.argi1 &amp; USER_LEAVING) != 0, args.argi2,</span><br><span class="line">                          (args.argi1 &amp; DONT_REPORT) != 0, args.argi3);</span><br><span class="line">                  maybeSnapshot();</span><br><span class="line">                  Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">              &#125; break;</span><br></pre></td></tr></table></figure>

<p>进到了<code>handlePauseActivity()</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private void handlePauseActivity(IBinder token, boolean finished,</span><br><span class="line">            boolean userLeaving, int configChanges, boolean dontReport, int seq) &#123;</span><br><span class="line">        ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">        if (r != null) &#123;</span><br><span class="line"></span><br><span class="line">            performPauseActivity(token, finished, r.isPreHoneycomb(), &quot;handlePauseActivity&quot;);</span><br><span class="line"></span><br><span class="line">            // Tell the activity manager we have paused.</span><br><span class="line">            if (!dontReport) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    ActivityManagerNative.getDefault().activityPaused(token);</span><br><span class="line">                &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                    throw ex.rethrowFromSystemServer();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mSomeActivitiesChanged = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>函数首先将Binder引用token转换成ActivityRecord的远程接口ActivityClientRecord，然后做了三个事情：</p>
<ol>
<li>如果userLeaving为true，则通过调用performUserLeavingActivity函数来调用Activity.onUserLeaveHint通知Activity，用户要离开它了；</li>
<li>调用performPauseActivity函数来调用Activity.onPause函数，我们知道，在Activity的生命周期中，当它要让位于其它的Activity时，系统就会调用它的onPause函数；</li>
<li>它通知ActivityManagerService，这个Activity已经进入Paused状态了，ActivityManagerService现在可以完成未竟的事情，即启动MainActivity了。<br><code>ActivityManagerProxy</code>里<code>activityPaused</code>函数如下:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void activityPaused(IBinder token) throws RemoteException</span><br><span class="line">    &#123;</span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">        data.writeStrongBinder(token);</span><br><span class="line">        mRemote.transact(ACTIVITY_PAUSED_TRANSACTION, data, reply, 0);</span><br><span class="line">        reply.readException();</span><br><span class="line">        data.recycle();</span><br><span class="line">        reply.recycle();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="step8–ActivityManagerService-activityPaused"><a href="#step8–ActivityManagerService-activityPaused" class="headerlink" title="step8–ActivityManagerService.activityPaused"></a>step8–ActivityManagerService.activityPaused</h2><p><strong>备注:又来到了AMS所在的进程！！！</strong><br>上面的步骤经过进程间通信来到ActivityManagerNative里的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">case ACTIVITY_PAUSED_TRANSACTION: &#123;</span><br><span class="line">           data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">           IBinder token = data.readStrongBinder();</span><br><span class="line">           activityPaused(token);</span><br><span class="line">           reply.writeNoException();</span><br><span class="line">           return true;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>调到AMS的<code>activityPaused()</code>函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public final void activityPaused(IBinder token) &#123;</span><br><span class="line">       final long origId = Binder.clearCallingIdentity();</span><br><span class="line">       synchronized(this) &#123;</span><br><span class="line">           ActivityStack stack = ActivityRecord.getStackLocked(token);</span><br><span class="line">           if (stack != null) &#123;</span><br><span class="line">               stack.activityPausedLocked(token, false);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       Binder.restoreCallingIdentity(origId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="step9–ActivityStack-activityPausedLocked"><a href="#step9–ActivityStack-activityPausedLocked" class="headerlink" title="step9–ActivityStack.activityPausedLocked"></a>step9–ActivityStack.activityPausedLocked</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">final void activityPausedLocked(IBinder token, boolean timeout) &#123;</span><br><span class="line">        if (DEBUG_PAUSE) Slog.v(TAG_PAUSE,</span><br><span class="line">            &quot;Activity paused: token=&quot; + token + &quot;, timeout=&quot; + timeout);</span><br><span class="line"></span><br><span class="line">        final ActivityRecord r = isInStackLocked(token);</span><br><span class="line">        if (r != null) &#123;</span><br><span class="line">            mHandler.removeMessages(PAUSE_TIMEOUT_MSG, r);</span><br><span class="line">            if (mPausingActivity == r) &#123;</span><br><span class="line">                if (DEBUG_STATES) Slog.v(TAG_STATES, &quot;Moving to PAUSED: &quot; + r</span><br><span class="line">                        + (timeout ? &quot; (due to timeout)&quot; : &quot; (pause complete)&quot;));</span><br><span class="line">                completePauseLocked(true, null);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>调到了内部函数<code>completePauseLocked()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">completePauseLocked()&#123;</span><br><span class="line">.......</span><br><span class="line">    if (resumeNext) &#123;</span><br><span class="line">            final ActivityStack topStack = mStackSupervisor.getFocusedStack();</span><br><span class="line">            if (!mService.isSleepingOrShuttingDownLocked()) &#123;</span><br><span class="line">                mStackSupervisor.resumeFocusedStackTopActivityLocked(topStack, prev, null);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终调了<code>ActivityStackSupervisor</code>里的<code>resumeFocusedStackTopActivityLocked</code>函数.</p>
<h2 id="step10–ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><a href="#step10–ActivityStackSupervisor-resumeFocusedStackTopActivityLocked" class="headerlink" title="step10–ActivityStackSupervisor.resumeFocusedStackTopActivityLocked"></a>step10–ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</h2><p>通过之前流程可以知道，当前在堆栈顶端的Activity为我们即将要启动的Activity,而Launcher对应的Activity已经被paused了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">boolean resumeFocusedStackTopActivityLocked(</span><br><span class="line">            ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions) &#123;</span><br><span class="line">        if (targetStack != null &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">            return targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">        &#125;</span><br><span class="line">        final ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">        if (r == null || r.state != RESUMED) &#123;</span><br><span class="line">            mFocusedStack.resumeTopActivityUncheckedLocked(null, null);</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后调用ActivityStack的resumeTopActivityUncheckedLocked()函数.</p>
<h2 id="step10–ActivityStack-resumeTopActivityUncheckedLocked"><a href="#step10–ActivityStack-resumeTopActivityUncheckedLocked" class="headerlink" title="step10–ActivityStack.resumeTopActivityUncheckedLocked"></a>step10–ActivityStack.resumeTopActivityUncheckedLocked</h2><p>在<code>resumeTopActivityUncheckedLocked</code>函数里调了自身的<code>resumeTopActivityInnerLocked</code>,然后调自身的<code>resumeTopActivityInnerLocked</code>,最终调了<code>mStackSupervisor.startSpecificActivityLocked(next, true, true)</code>.</p>
<h2 id="step11–ActivityStackSupervisor-startSpecificActivityLocked"><a href="#step11–ActivityStackSupervisor-startSpecificActivityLocked" class="headerlink" title="step11–ActivityStackSupervisor.startSpecificActivityLocked"></a>step11–ActivityStackSupervisor.startSpecificActivityLocked</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0,</span><br><span class="line">                &quot;activity&quot;, r.intent.getComponent(), false, false, true);</span><br></pre></td></tr></table></figure>

<p>调到了<code>ActivityManagerService</code>里.</p>
<h2 id="step12–ActivityManagerService-startProcessLocked"><a href="#step12–ActivityManagerService-startProcessLocked" class="headerlink" title="step12–ActivityManagerService.startProcessLocked"></a>step12–ActivityManagerService.startProcessLocked</h2><p>此函数里核心代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">checkTime(startTime, &quot;startProcess: asking zygote to start proc&quot;);</span><br><span class="line">            Process.ProcessStartResult startResult = Process.start(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, entryPointArgs);</span><br><span class="line">            checkTime(startTime, &quot;startProcess: returned from zygote!&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="step13–Process-start"><a href="#step13–Process-start" class="headerlink" title="step13–Process.start()"></a>step13–Process.start()</h2><p>最终来到了Process(<code>./frameworks/base/core/java/android/os/Process.java</code>),调用自身<code>startViaZygote()</code>,在这个函数里最后一句是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);</span><br></pre></td></tr></table></figure>

<p>首先通过<code>openZygoteSocketIfNeeded</code>,建AMS进程和Zygote进程通过socket进行跨进程通信的连接.<br>然后<code>zygoteSendArgsAndGetResult()</code>这个函数向zygote进程发送一个参数列表，zygote进程会启动一个新的子进程并返回该子进程的pid号。<br>请求的参数中有一个字符串，它的值是“android.app.ActivityThread”。现在该回到zygote处理请求那块去看看了——就是runSelectLoop函数，具体在<code>ZygoteInit</code>里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">private static void runSelectLoop(String abiList) throws MethodAndArgsCaller &#123;</span><br><span class="line">.........</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            StructPollfd[] pollFds = new StructPollfd[fds.size()];</span><br><span class="line">            for (int i = 0; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">                pollFds[i] = new StructPollfd();</span><br><span class="line">                pollFds[i].fd = fds.get(i);</span><br><span class="line">                pollFds[i].events = (short) POLLIN;</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                Os.poll(pollFds, -1);</span><br><span class="line">            &#125; catch (ErrnoException ex) &#123;</span><br><span class="line">                throw new RuntimeException(&quot;poll failed&quot;, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            for (int i = pollFds.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">                if ((pollFds[i].revents &amp; POLLIN) == 0) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                if (i == 0) &#123;</span><br><span class="line">                    ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                    peers.add(newPeer);</span><br><span class="line">                    fds.add(newPeer.getFileDesciptor());</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    boolean done = peers.get(i).runOnce();</span><br><span class="line">                    if (done) &#123;</span><br><span class="line">                        peers.remove(i);</span><br><span class="line">                        fds.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到里面是一个while循环，一直在监听socket发来的信息，最终调用了<code>ZygoteConnection</code>里的<code>runOnce</code>函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   boolean runOnce() throws ZygoteInit.MethodAndArgsCaller &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</span><br><span class="line">                    parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</span><br><span class="line">                    parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</span><br><span class="line">                    parsedArgs.appDataDir);</span><br><span class="line">        &#125;</span><br><span class="line">.......</span><br><span class="line">if (pid == 0) &#123;</span><br><span class="line">                // in child</span><br><span class="line">                IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">                serverPipeFd = null;</span><br><span class="line">                handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span><br><span class="line"></span><br><span class="line">                // should never get here, the child is expected to either</span><br><span class="line">                // throw ZygoteInit.MethodAndArgsCaller or exec().</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>这里最终调到了Zygote的两个关键函数<code>forkAndSpecialize</code>函数，然后通过JNI调用了<code>nativeForkAndSpecialize</code>函数,这个函数最终fork了一个子进程,暂时忽略.<br>另外一个函数是<code>handleChildProc()</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (parsedArgs.invokeWith != null) &#123;</span><br><span class="line">           WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">                   parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">                   VMRuntime.getCurrentInstructionSet(),</span><br><span class="line">                   pipeFd, parsedArgs.remainingArgs);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,</span><br><span class="line">                   parsedArgs.remainingArgs, null /* classLoader */);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里会走到<code>RuntimeInit.zygoteInit</code>,然后调内部的<code>applicationInit()</code>函数,再调内部的<code>invokeStaticMain()</code>函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  private static void invokeStaticMain(String className, String[] argv, ClassLoader classLoader)</span><br><span class="line">            throws ZygoteInit.MethodAndArgsCaller &#123;</span><br><span class="line">        Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            cl = Class.forName(className, true, classLoader);</span><br><span class="line">        &#125; </span><br><span class="line">......</span><br><span class="line">        Method m;</span><br><span class="line">        try &#123;</span><br><span class="line">            m = cl.getMethod(&quot;main&quot;, new Class[] &#123; String[].class &#125;);</span><br><span class="line">        &#125; catch (NoSuchMethodException ex) &#123;</span><br><span class="line">            throw new RuntimeException(</span><br><span class="line">                    &quot;Missing static main on &quot; + className, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，上述代码完成了一个反射的功能，去加载传进来的类名的<code>main</code>方法。在打开应用过程中，这个类名就是<code>android.app.ActivityThread</code></p>
<h2 id="step14–ActivityThread-main"><a href="#step14–ActivityThread-main" class="headerlink" title="step14–ActivityThread.main()"></a>step14–ActivityThread.main()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        SamplingProfilerIntegration.start();</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">        Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;);</span><br><span class="line"></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">        ActivityThread thread = new ActivityThread();</span><br><span class="line">        thread.attach(false);</span><br><span class="line"></span><br><span class="line">        if (sMainThreadHandler == null) &#123;</span><br><span class="line">            sMainThreadHandler = thread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br></pre></td></tr></table></figure>

<p>在main函数里，创建了<code>ActivityThread</code>和主Ui线程Handler,然后调用它的attach函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">final IActivityManager mgr = ActivityManagerNative.getDefault();</span><br><span class="line">            try &#123;</span><br><span class="line">                mgr.attachApplication(mAppThread);</span><br><span class="line">            &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                throw ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>mgr</code>就是<code>ActivityManagerService</code>的远程接口<code>ActivityManagerProxy</code>的<code>attachApplication</code>函数.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void attachApplication(IApplicationThread app) throws RemoteException</span><br><span class="line">   &#123;</span><br><span class="line">       Parcel data = Parcel.obtain();</span><br><span class="line">       Parcel reply = Parcel.obtain();</span><br><span class="line">       data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">       data.writeStrongBinder(app.asBinder());</span><br><span class="line">       mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, 0);</span><br><span class="line">       reply.readException();</span><br><span class="line">       data.recycle();</span><br><span class="line">       reply.recycle();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里传进来的参数就是刚刚创建进程的远程调用接口,将其传给AMS。通过跨进程通讯，来到了<code>ActivityManagerService</code>的<code>attachApplication</code>函数。</p>
<h2 id="step15–ActivityManagerService-attachApplication"><a href="#step15–ActivityManagerService-attachApplication" class="headerlink" title="step15–ActivityManagerService.attachApplication()"></a>step15–ActivityManagerService.attachApplication()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (normalMode) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">               if (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                   didSomething = true;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; catch (Exception e) &#123;</span><br><span class="line">               Slog.wtf(TAG, &quot;Exception thrown launching activities in &quot; + app, e);</span><br><span class="line">               badApp = true;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>这里进到了<code>attachApplicationLocked</code>函数.</p>
<h2 id="step16–ActivityStackSupervisor-attachApplicationLocked"><a href="#step16–ActivityStackSupervisor-attachApplicationLocked" class="headerlink" title="step16–ActivityStackSupervisor.attachApplicationLocked()"></a>step16–ActivityStackSupervisor.attachApplicationLocked()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ActivityRecord hr = stack.topRunningActivityLocked();</span><br><span class="line">                if (hr != null) &#123;</span><br><span class="line">                    if (hr.app == null &amp;&amp; app.uid == hr.info.applicationInfo.uid</span><br><span class="line">                            &amp;&amp; processName.equals(hr.processName)) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            if (realStartActivityLocked(hr, app, true, true)) &#123;</span><br><span class="line">                                didSomething = true;</span><br><span class="line">                            .....</span><br></pre></td></tr></table></figure>

<p>这里先调ActivityStack的topRunningActivityLocked，然后再调自己的<code>realStartActivityLocked</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.thread.scheduleLaunchActivity(new Intent(r.intent), r.appToken,</span><br><span class="line">                    System.identityHashCode(r), r.info, new Configuration(mService.mConfiguration),</span><br><span class="line">                    new Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,</span><br><span class="line">                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</span><br><span class="line">                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br></pre></td></tr></table></figure>

<p>这里app.thread最终进到了<code>ApplicationThreadProxy</code>的<code>scheduleLaunchActivity</code>函数中。</p>
<h2 id="step17–ApplicationThreadProxy-scheduleLaunchActivity"><a href="#step17–ApplicationThreadProxy-scheduleLaunchActivity" class="headerlink" title="step17–ApplicationThreadProxy.scheduleLaunchActivity()"></a>step17–ApplicationThreadProxy.scheduleLaunchActivity()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mRemote.transact(SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION, data, null,</span><br><span class="line">               IBinder.FLAG_ONEWAY);</span><br></pre></td></tr></table></figure>

<p>AMS通过Binder通信，告诉<code>SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION</code>，进到了<code>scheduleLaunchActivity</code></p>
<h2 id="step18–ApplicationThreadProxy-scheduleLaunchActivity"><a href="#step18–ApplicationThreadProxy-scheduleLaunchActivity" class="headerlink" title="step18–ApplicationThreadProxy.scheduleLaunchActivity()"></a>step18–ApplicationThreadProxy.scheduleLaunchActivity()</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public final void scheduleLaunchActivity(Intent intent, IBinder token, int ident...)</span><br><span class="line">      sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>来到了Handler(H)的handleMessage函数里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">case LAUNCH_ACTIVITY: &#123;</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityStart&quot;);</span><br><span class="line">                    final ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">                    r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                            r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">                    handleLaunchActivity(r, null, &quot;LAUNCH_ACTIVITY&quot;);</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                &#125; break;</span><br></pre></td></tr></table></figure>

<p>调用自己的<code>handleLaunchActivity</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent, String reason) &#123;</span><br><span class="line">......</span><br><span class="line">        Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">        if (a != null) &#123;</span><br><span class="line">           .....</span><br><span class="line">            handleResumeActivity(r.token, false, r.isForward,</span><br><span class="line">                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line">                    ....</span><br><span class="line">                performPauseActivityIfNeeded(r, reason);</span><br></pre></td></tr></table></figure>

<p>在<code>handleLaunchActivity</code>函数里主要干了两个重要事情,第一是通过<code>performLaunchActivity</code>去加载一个<code>Activity</code>,然后调用它的<code>onCreate</code>方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">.........</span><br><span class="line"></span><br><span class="line">        if (r.activityInfo.targetActivity != null) &#123;</span><br><span class="line">            component = new ComponentName(r.activityInfo.packageName,</span><br><span class="line">                    r.activityInfo.targetActivity);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Activity activity = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">            activity = mInstrumentation.newActivity(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">        &#125; .....</span><br><span class="line">        try &#123;</span><br><span class="line">            Application app = r.packageInfo.makeApplication(false, mInstrumentation);</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">            if (activity != null) &#123;</span><br><span class="line">                Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">                Configuration config = new Configuration(mCompatConfiguration);</span><br><span class="line">               ....</span><br><span class="line">                activity.attach(appContext, this, getInstrumentation(), r)</span><br><span class="line">                ....</span><br><span class="line">                if (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>performLaunchActivity</code>函数里，先通过类加载器创建一个<code>Activity</code>对象，然后创建<code>Application</code>对象,调用<code>Activity</code>的<code>attach()</code>,再通过<code>mInstrumentation.callActivityOnCreate</code>调Activity的<code>onCreate</code>。然后回到<code>handleLaunchActivity</code>函数，执行<code>handleResumeActivity</code>,即调Activity的<code>onResume()</code>生命周期。终于，新打开的<code>Activity</code>启动起来了!!!</p>
<h2 id="过程总结"><a href="#过程总结" class="headerlink" title="过程总结"></a>过程总结</h2><p>整个应用程序的启动过程要执行很多步骤，但是整体来看，主要分为以下五个阶段：</p>
<ol>
<li><p>Launcher通过Binder进程间通信机制通知AMS，它要启动一个Activity；</p>
</li>
<li><p>AMS通过Binder进程间通信机制通知Launcher进入Paused状态；</p>
</li>
<li><p>Launcher通过Binder进程间通信机制通知AMS它已经准备就绪进入Paused状态，于是AMS就创建一个新的进程，用来启动一个ActivityThread实例，即将要启动的Activity就是在这个ActivityThread实例中运行；</p>
</li>
<li><p>ActivityThread通过Binder进程间通信机制将一个ApplicationThread类型的Binder对象传递给AMS，以便以后AMS能够通过这个Binder对象和它进行通信；</p>
</li>
<li><p>AMS通过Binder进程间通信机制通知ActivityThread，现在一切准备就绪，它可以真正执行Activity的启动操作了。</p>
</li>
</ol>
<h2 id="调用流程图"><a href="#调用流程图" class="headerlink" title="调用流程图"></a>调用流程图</h2><p><img src="http://image.yangq.me/blog/history/16-7-5/activityStart.png" alt></p>

    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/Android/" rel="tag"># Android</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/post/170b145.html" rel="prev" title="在Vultr Debian7上搭建科学上网，使用锐速畅享十倍提速">
                  在Vultr Debian7上搭建科学上网，使用锐速畅享十倍提速 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    <div class="comments" id="gitalk-container"></div>
  

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#step3–Instrumentation-execStartActivity"><span class="nav-number">1.</span> <span class="nav-text">step3–Instrumentation.execStartActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step4–ActivityManagerProxy-startActivity"><span class="nav-number">2.</span> <span class="nav-text">step4–ActivityManagerProxy.startActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step4–ActivityManagerService-startActivity"><span class="nav-number">3.</span> <span class="nav-text">step4–ActivityManagerService.startActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step5–ActivityStarter-startActivityMayWait"><span class="nav-number">4.</span> <span class="nav-text">step5–ActivityStarter.startActivityMayWait</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step6–ApplicationThreadProxy-schedulePauseActivity"><span class="nav-number">5.</span> <span class="nav-text">step6–ApplicationThreadProxy.schedulePauseActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step7–ApplicationThread-schedulePauseActivity"><span class="nav-number">6.</span> <span class="nav-text">step7–ApplicationThread.schedulePauseActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step8–ActivityManagerService-activityPaused"><span class="nav-number">7.</span> <span class="nav-text">step8–ActivityManagerService.activityPaused</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step9–ActivityStack-activityPausedLocked"><span class="nav-number">8.</span> <span class="nav-text">step9–ActivityStack.activityPausedLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step10–ActivityStackSupervisor-resumeFocusedStackTopActivityLocked"><span class="nav-number">9.</span> <span class="nav-text">step10–ActivityStackSupervisor.resumeFocusedStackTopActivityLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step10–ActivityStack-resumeTopActivityUncheckedLocked"><span class="nav-number">10.</span> <span class="nav-text">step10–ActivityStack.resumeTopActivityUncheckedLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step11–ActivityStackSupervisor-startSpecificActivityLocked"><span class="nav-number">11.</span> <span class="nav-text">step11–ActivityStackSupervisor.startSpecificActivityLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step12–ActivityManagerService-startProcessLocked"><span class="nav-number">12.</span> <span class="nav-text">step12–ActivityManagerService.startProcessLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step13–Process-start"><span class="nav-number">13.</span> <span class="nav-text">step13–Process.start()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step14–ActivityThread-main"><span class="nav-number">14.</span> <span class="nav-text">step14–ActivityThread.main()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step15–ActivityManagerService-attachApplication"><span class="nav-number">15.</span> <span class="nav-text">step15–ActivityManagerService.attachApplication()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step16–ActivityStackSupervisor-attachApplicationLocked"><span class="nav-number">16.</span> <span class="nav-text">step16–ActivityStackSupervisor.attachApplicationLocked()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step17–ApplicationThreadProxy-scheduleLaunchActivity"><span class="nav-number">17.</span> <span class="nav-text">step17–ApplicationThreadProxy.scheduleLaunchActivity()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step18–ApplicationThreadProxy-scheduleLaunchActivity"><span class="nav-number">18.</span> <span class="nav-text">step18–ApplicationThreadProxy.scheduleLaunchActivity()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过程总结"><span class="nav-number">19.</span> <span class="nav-text">过程总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调用流程图"><span class="nav-number">20.</span> <span class="nav-text">调用流程图</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/avatar.jpg"
      alt="老实念佛">
  <p class="site-author-name" itemprop="name">老实念佛</p>
  <div class="site-description" itemprop="description">小小程序员</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">老实念佛</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.0</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  








  <script src="/js/local-search.js?v=7.4.0"></script>














  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '60d9686c526081007639',
      clientSecret: '2cb744c4370e936e30bcd161c1c142fadabe6d46',
      repo: 'blogcomments',
      owner: 'yangq212607',
      admin: ['yangq212607'],
      id: '60512c00f0e6096a27612d4ccec6a4d0',
        language: 'zh-CN',
      
      distractionFreeMode: 'true'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
</script>

</body>
</html>
